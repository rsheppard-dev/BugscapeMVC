@model BugscapeMVC.Models.ViewModels.DashboardViewModel

@using Microsoft.AspNetCore.Identity
@using BugscapeMVC.Services.Interfaces
@using BugscapeMVC.Models.Enums

@inject UserManager<AppUser> UserManager
@inject IFileService FileService
@inject IRoleService RolesService
@inject IProjectService ProjectService

@{
    ViewData["Title"] = "Dashboard";
    AppUser? user = await UserManager.GetUserAsync(User);
}

<section class="grid grid-cols-12 justify-between gap-4 mb-6">
    <a asp-action="Index" asp-controller="Projects"
        class="rounded-lg bg-info px-4 py-2 flex justify-between items-center gap-2 w-full col-span-6 xl:col-span-3">
        <div class="flex flex-col gap-1 font-dark">
            <span class="font-rockwell text-4xl">@Model.Projects?.Where(p => p.StartDate < DateTime.Now && p.EndDate >
                DateTime.Now).Count()</span>
            <span class="font-lato text-sm">Active Projects</span>
        </div>
        <div class="w-14">
            <img src="~/images/default-projects.png" alt="Active Projects">
        </div>
    </a>

    <a asp-action="Index" asp-controller="Tickets"
        class="rounded-lg bg-success px-4 py-2 flex justify-between items-center gap-2 w-full col-span-6 xl:col-span-3">
        <div class="flex flex-col gap-1 font-dark">
            <span class="font-rockwell text-4xl">@Model.Tickets?.Count()</span>
            <span class="font-lato text-sm">Open Tickets</span>
        </div>
        <div class="w-14">
            <img src="~/images/default-tickets.png" alt="Open Tickets">
        </div>
    </a>

    <a asp-action="Index" asp-controller="Tickets"
        class="rounded-lg bg-warning px-4 py-2 flex justify-between items-center gap-2 w-full col-span-6 xl:col-span-3">
        <div class="flex flex-col gap-1 font-dark">
            <span class="font-rockwell text-4xl">@Model.Tickets?.Where(t =>
                string.IsNullOrEmpty(t.DeveloperUserId)).Count()</span>
            <span class="font-lato text-sm">Unassigned Tickets</span>
        </div>
        <div class="w-14">
            <img src="~/images/unassigned-tickets.png" alt="Unassigned Tickets">
        </div>
    </a>

    <a asp-action="Index" asp-controller="Tickets"
        class="rounded-lg bg-danger px-4 py-2 flex justify-between items-center gap-2 w-full col-span-6 xl:col-span-3">
        <div class="flex flex-col gap-1 font-dark">
            <span class="font-rockwell text-4xl">@Model.Company?.Members.Count()</span>
            <span class="font-lato text-sm">Team Members</span>
        </div>
        <div class="w-14">
            <img src="~/images/default-team.png" alt="Team Members">
        </div>
    </a>
</section>

<div class="grid grid-cols-12 gap-6 mb-6">
    @if (Model.Tickets?.Count > 0)
    {
        <section class="col-span-12 lg:col-span-4 rounded-md bg-white px-6 py-3 flex flex-col lg:order-2">
            <h2 class="font-rockwell text-dark text-xl font-bold mb-4">Tickets By Priority</h2>
            <div class="h-full flex items-center justify-center">
                <canvas data-chart="tickets by priority"></canvas>
            </div>
        </section>
    }

    @if (Model.Tickets?.Count > 0)
    {
        <section class="col-span-12 lg:col-span-8 rounded-md bg-white px-6 py-3 flex flex-col lg:order-1">
            <h2 class="font-rockwell text-dark text-xl font-bold">Tickets Resolved</h2>
            <span class="block font-lato text-gray-400 mb-4">Last 30 Days</span>
            <div class="h-full flex justify-center items-center">
                <canvas data-chart="tickets resolved"></canvas>
            </div>
        </section>
    }

    <section class="col-span-12 lg:col-span-8 rounded-md bg-white px-6 py-3 flex flex-col lg:order-3">
        <div class="flex justify-between items-center mb-6">
            <h2 class="font-rockwell text-dark text-xl font-bold">Projects</h2>

            <a asp-action="Index" asp-controller="Projects" title="Projects"
                class="bg-mid px-4 py-2 text-dark rounded-lg flex items-center gap-2 group">
                <span class="font-lato text-sm">@Model.Projects?.Count</span>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-4 h-4 group-hover:translate-x-1 transition-transform">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                </svg>
            </a>
        </div>

        @if (Model.Projects is null || Model.Projects?.Count == 0)
        {
            <p class="font-lato flex flex-col gap-4 grow">There are currently no projects to show.</p>
        }
        else
        {
            <div data-container="projects"
                class="grow relative overflow-x-auto rounded-t-lg scrollbar-thin scrollbar-thumb-light scrollbar-track-white">
                @await Html.PartialAsync("~/Views/Projects/_ProjectsTablePartial.cshtml", new
                         PaginatedList<Project>(Model.Projects ?? new List<Project>(), 1, 10))
            </div>
        }

        @if (User.IsInRole(nameof(Roles.Admin)))
        {
            <div>
                <hr class="my-4">

                <a asp-action="Create" asp-controller="Projects" class="flex items-center gap-2 w-fit group">
                    <div
                        class="bg-success group-hover:bg-opacity-80 transition-opacity flex items-center justify-center rounded-full p-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="fill-white h-4 w-4">
                            <path id="Icon_awesome-plus" data-name="Icon awesome-plus"
                                d="M18.571,10.107H12.143V3.679A1.429,1.429,0,0,0,10.714,2.25H9.286A1.429,1.429,0,0,0,7.857,3.679v6.429H1.429A1.429,1.429,0,0,0,0,11.536v1.429a1.429,1.429,0,0,0,1.429,1.429H7.857v6.429A1.429,1.429,0,0,0,9.286,22.25h1.429a1.429,1.429,0,0,0,1.429-1.429V14.393h6.429A1.429,1.429,0,0,0,20,12.964V11.536A1.429,1.429,0,0,0,18.571,10.107Z"
                                transform="translate(0 -2.25)" />
                        </svg>
                    </div>
                    <span class="font-lato font-bold text-sm">Create new project</span>
                </a>
            </div>
        }
    </section>

    <section class="col-span-12 rounded-md bg-white px-6 py-3 flex flex-col lg:order-5">
        <div class="flex justify-between items-center mb-6">
            <h2 class="font-rockwell text-dark text-xl font-bold">Tickets</h2>

            <a asp-action="Index" asp-controller="Tickets" title="Tickets"
                class="bg-mid px-4 py-2 text-dark rounded-lg flex items-center gap-2 group">
                <span class="font-lato text-sm">@Model.Tickets?.Count</span>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-4 h-4 group-hover:translate-x-1 transition-transform">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                </svg>
            </a>
        </div>

        @if (Model.Tickets is null || Model.Tickets.Count == 0)
        {
            <p class="font-lato flex flex-col gap-4 grow">There are currently no tickets to show.</p>
        }
        else
        {
            <div data-container="tickets"
                class="grow relative overflow-x-auto rounded-t-lg scrollbar-thin scrollbar-thumb-light scrollbar-track-white">
                @await Html.PartialAsync("~/Views/Tickets/_TicketsTablePartial.cshtml", new
                         PaginatedList<Ticket>(Model.Tickets ?? new List<Ticket>(), 1, 10))
            </div>
        }

        <div>
            <hr class="my-4">

            <a asp-action="Create" asp-controller="Tickets" class="flex items-center gap-2 w-fit group">
                <div
                    class="bg-success group-hover:bg-opacity-80 transition-opacity flex items-center justify-center rounded-full p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="fill-white h-4 w-4">
                        <path id="Icon_awesome-plus" data-name="Icon awesome-plus"
                            d="M18.571,10.107H12.143V3.679A1.429,1.429,0,0,0,10.714,2.25H9.286A1.429,1.429,0,0,0,7.857,3.679v6.429H1.429A1.429,1.429,0,0,0,0,11.536v1.429a1.429,1.429,0,0,0,1.429,1.429H7.857v6.429A1.429,1.429,0,0,0,9.286,22.25h1.429a1.429,1.429,0,0,0,1.429-1.429V14.393h6.429A1.429,1.429,0,0,0,20,12.964V11.536A1.429,1.429,0,0,0,18.571,10.107Z"
                            transform="translate(0 -2.25)" />
                    </svg>
                </div>
                <span class="font-lato font-bold text-sm">Submit new ticket</span>
            </a>
        </div>
    </section>

    <section class="col-span-12 lg:col-span-4 rounded-md bg-white px-6 py-3 flex flex-col lg:order-4">
        <div class="flex justify-between items-center mb-6">
            <h2 class="font-rockwell text-dark text-xl font-bold">Team</h2>

            <a asp-action="Index" asp-controller="Projects" title="Members"
                class="bg-mid group px-4 py-2 text-dark rounded-lg flex items-center gap-2">
                <span class="font-lato text-sm">@Model.Members?.Count</span>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-4 h-4 group-hover:translate-x-1 transition-transform">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                </svg>
            </a>
        </div>

        @if (Model.Members is null || Model.Members?.Count == 0)
        {
            <div class="flex flex-col gap-4 grow">
                <p class="font-lato">There are currently no team members to show.</p>
            </div>
        }
        else
        {
            <div class="flex flex-col gap-4 grow">
                @foreach (AppUser member in Model.Members!.OrderBy(member => member.FirstName).ThenBy(member =>
               member.LastName))
                {
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            @if (member.AvatarFileData is null || member.AvatarContentType is null)
                            {
                                <img class="h-10 w-10 object-cover rounded-full ring-4 ring-mid" src="~/images/default-avatar.png"
                                    alt="@member.FullName">
                            }
                            else
                            {
                                <img class="h-10 w-10 object-cover rounded-full ring-4 ring-mid"
                                    src="@FileService.ConvertByteArrayToFile(member.AvatarFileData, member.AvatarContentType)"
                                    alt="@member.FullName">
                            }

                            <div class="flex flex-col">
                                <strong class="font-bold font-lato text-sm">@member.FullName</strong>
                                <span
                                    class="font-lato text-gray-400 text-xs">@((RolesService.GetUserRolesAsync(member)).Result.FirstOrDefault()?.Replace("_",
                            " "))</span>
                            </div>
                        </div>

                        <a href="mailto:@member.Email" class="p-2 bg-mid rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor" class="w-5 h-5 stroke-dark">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
                            </svg>
                        </a>
                    </div>
                }
            </div>
        }

        @if (User.IsInRole(nameof(Roles.Admin)))
        {
            <div>
                <hr class="my-4">

                <a asp-action="Create" asp-controller="Invites" class="flex items-center gap-2 w-fit group">
                    <div
                        class="bg-success group-hover:bg-opacity-80 transition-opacity flex items-center justify-center rounded-full p-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="fill-white h-4 w-4">
                            <path id="Icon_awesome-plus" data-name="Icon awesome-plus"
                                d="M18.571,10.107H12.143V3.679A1.429,1.429,0,0,0,10.714,2.25H9.286A1.429,1.429,0,0,0,7.857,3.679v6.429H1.429A1.429,1.429,0,0,0,0,11.536v1.429a1.429,1.429,0,0,0,1.429,1.429H7.857v6.429A1.429,1.429,0,0,0,9.286,22.25h1.429a1.429,1.429,0,0,0,1.429-1.429V14.393h6.429A1.429,1.429,0,0,0,20,12.964V11.536A1.429,1.429,0,0,0,18.571,10.107Z"
                                transform="translate(0 -2.25)" />
                        </svg>
                    </div>
                    <span class="font-lato font-bold text-sm">Invite new team member</span>
                </a>
            </div>
        }
    </section>
</div>

@section scripts {
    <script src="~/js/projectsTable.js"></script>
    <script src="~/js/ticketsTable.js"></script>

    <script>
        const ticketsTable = new TicketsTable(@Html.Raw(Json.Serialize(Model.Tickets)));
        const projectsTable = new ProjectsTable(@Html.Raw(Json.Serialize(Model.Projects)));

        ticketsTable.init();
        projectsTable.init();
    </script>

    <!-- *** Begin Chart JS Pie/Donut *** -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"
        integrity="sha512-SIMGYRUjwY8+gKg7nn9EItdD8LCADSDfJNutF9TPrvEo86sQmFMh6MyralfIyhADlajSxqc7G0gs7+MwWF/ogQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
        const ticketsByPriority = document.querySelector('[data-chart="tickets by priority"]');
        const ticketsResolved = document.querySelector('[data-chart="tickets resolved"]');

        new Chart(ticketsByPriority, {
            type: 'doughnut',
            data: {
                labels: [
                    '@nameof(Priorities.Low)',
                    '@nameof(Priorities.Medium)',
                    '@nameof(Priorities.High)',
                    '@nameof(Priorities.Urgent)'
                ],
                datasets: [{
                    label: 'Tickets By Priority',
                    data: [
        @Model.Tickets?.Where(ticket => ticket.TicketPriority?.Name == nameof(Priorities.Low)).Count(),
        @Model.Tickets?.Where(ticket => ticket.TicketPriority?.Name == nameof(Priorities.Medium)).Count(),
        @Model.Tickets?.Where(ticket => ticket.TicketPriority?.Name == nameof(Priorities.High)).Count(),
        @Model.Tickets?.Where(ticket => ticket.TicketPriority?.Name == nameof(Priorities.Urgent)).Count(),
                    ],
                    backgroundColor: [
                        '#0AD69F',
                        '#00B4D8',
                        '#FFD166',
                        '#EF476F'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                plugins: {
                    legend: {
                        position: 'bottom', // Place the legend at the bottom
                        labels: {
                            usePointStyle: true, // Display legend keys as circles
                        },
                    },
                },
            },
        });

        const today = new Date();
        const days = [];
        const dataSubmitted = [];
        const dataResolved = [];

        // Generate data for the last 30 days, starting from today and going backward
        for (let i = 29; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(today.getDate() - i); // Calculate the date for each day

            // Format the date as desired (e.g., 'Sep 01')
            const formattedDate = date.toLocaleString('default', { month: 'short', day: '2-digit' });

            // Push the formatted date to the labels array
            days.push(formattedDate);

            // Generate some example data for Tickets Submitted and Tickets Resolved
            dataSubmitted.push(Math.floor(Math.random() * 100));
            dataResolved.push(Math.floor(Math.random() * 100));
        }

        new Chart(ticketsResolved, {
            type: 'line',
            data: {
                labels: days,
                datasets: [
                    {
                        label: 'Tickets Submitted',
                        data: dataSubmitted,
                        borderColor: '#00B4D8',
                        tension: 0.1
                    },
                    {
                        label: 'Tickets Resolved',
                        data: dataResolved,
                        borderColor: '#0AD69F',
                        tension: 0.1
                    }
                ]
            },
            options: {
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            generateLabels: function (chart) {
                                const labels = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                labels.forEach(function (label) {
                                    const dataset = chart.data.datasets.find(d => d.label === label.text);
                                    if (dataset) {
                                        label.fillStyle = dataset.borderColor;
                                    }
                                });
                                return labels;
                            }
                        },
                    },
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Date'
                        },
                        ticks: {
                            autoSkip: true, // Automatically skip labels to avoid clutter
                            maxTicksLimit: 6 // Maximum number of labels to display (adjust as needed)
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Value'
                        }
                    }
                }
            }
        });
    </script>
}